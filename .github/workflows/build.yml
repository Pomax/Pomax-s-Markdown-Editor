name: Build Executables

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run dist:win
      - uses: actions/upload-artifact@v4
        with:
          name: build-windows
          path: dist/*
          retention-days: 1

  build-macos:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run dist:mac
      - uses: actions/upload-artifact@v4
        with:
          name: build-macos
          path: dist/*
          retention-days: 1

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run dist:linux
      - uses: actions/upload-artifact@v4
        with:
          name: build-linux
          path: dist/*
          retention-days: 1

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Get version from package.json
        id: version
        run: echo "version=$(node -p 'require(\"./package.json\").version')" >> "$GITHUB_OUTPUT"
      - uses: actions/download-artifact@v4
        with:
          name: build-windows
          path: artifacts
      - uses: actions/download-artifact@v4
        with:
          name: build-macos
          path: artifacts
      - uses: actions/download-artifact@v4
        with:
          name: build-linux
          path: artifacts
      - name: Create or update release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ steps.version.outputs.version }}"

          # Delete existing release and tag if they exist
          gh release delete "$TAG" --yes --cleanup-tag 2>/dev/null || true

          # Create new release with all artifacts
          gh release create "$TAG" artifacts/* \
            --title "Markdown Editor $TAG" \
            --notes "Standalone executables for Windows, macOS, and Linux." \
            --latest
